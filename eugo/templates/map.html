{% load static %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
   
    <title>EUGO</title>
    
    <!--bootstrap CSS-->
    <link rel = "stylesheet" type = "text/css" href = '{% static "/eugo/css/bootstrap.css" %}'/>
    
    <link rel="icon" href='{%static "/eugo/img/favicon.ico"%}'>

    <!-- Custom styles for this template -->
    <link href='{% static "/eugo/css/leader.css" %}' rel="stylesheet"> 
    <link href='{% static "/eugo/css/map.css" %}' rel="stylesheet"> 

  </head>

  <body>

    {% if not user.is_authenticated %}

    <script>window.location.href = "/eugo/logout/";</script>

    {% endif %}

    <div class="text-center parent-container-map" id="parent-container-map-id">
        
        <div class="map" id="mapConID">
            <img src='{% static "/eugo/img/exe_map_alpha.png" %}' class="map-img">
        </div>

        {% for i in lec %}
        <div class="lec-map-pin " style="position: absolute; z-index: 4; font-size: 10px;
        font-weight: bold; list-style-type: none;" id={{i.id}} value={{i.pos}}>
            <li>{{ i.name }}</li>
            <li>{{ i.duration }} Mins Remaining</li>
            <li>{{ i.pos }}</li>
            <li><img src='{% static "/eugo/img/teacher_sprites/"%}{{i.sprite}}' class="spirite-img"></li>
            <li><button type="button" class="btn btn-light btn-sm" onclick="showCam('{{i.qrUrl}}','{{i.id}}')">Confirm QR Code</button></li>
        </div>
        {% endfor %}

        <button id="cam-button-cancel" onclick="hideCam()" style="position: absolute; text-align: center; top: 550px">Cancel</button> 
        <div style="width: 500px; position: absolute; text-align: center;" id="reader">
        </div>
        <div id="qr-reader-results"></div>
        </div>

        <input type="hidden" id="current-lec" value="">
        <input type="hidden" id="current-lec-id" value="">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/eugo/index">EUGO</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="/eugo/map">Map <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/eugo/lecturers">My Lecturers</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/eugo/lecturerdex">LecturerDex</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{ user.get_username }}
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="/eugo/player">Profile</a>
                  <a class="dropdown-item" href="/eugo/logout">Logout</a>
                </div>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="/eugo/mapmod">MAPMOD!</a>
            </li>
        </div>
      </nav>

      <!--Leaderboard-->
    <div class="leaderboard slidein" id="leaderboard">
        <h1>
        <svg class="ico-cup">
            <use xlink:href="#cup"></use>
        </svg>
        Most Lecturers Caught
        </h1>
        <ol>
        <li>
            <mark>{{ players.0.username }}</mark>
            <small>{{ players.0.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.1.username }}</mark>
            <small>{{ players.1.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.2.username }}</mark>
            <small>{{ players.2.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.3.username }}</mark>
            <small>{{ players.3.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.4.username }}</mark>
            <small>{{ players.4.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.5.username }}</mark>
            <small>{{ players.5.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.6.username }}</mark>
            <small>{{ players.6.pokemon_caught }}</small>
        </li>
        <li>
            <mark>{{ players.7.username }}</mark>
            <small>{{ players.7.pokemon_caught }}</small>
        </li>  
        </ol>
    </div>
    
    
    <script>
        window.onload = function(){
            mapContainer= document.getElementById("mapConID");
            var xOff = getOffset(mapContainer).left;
            var yOff = getOffset(mapContainer).top;
            pinL = document.getElementsByClassName("lec-map-pin")

            for (let i = 0; i < pinL.length; i++) {
                pin = pinL[i];
                var x = parseInt(pin.getAttribute("value").split(",")[0])
                var y = parseInt(pin.getAttribute("value").split(",")[1])
                pin.style.left = x + xOff+ "px";
                pin.style.top = y + yOff+ "px";
                console.log(x, y);
                var gifsrc = '{% static "/eugo/img/circle.gif" %}'
                pin.style.backgroundImage = "url("+ gifsrc +")";
                pin.style.backgroundSize = "contain";
                pin.style.backgroundRepeat = "no-repeat";
            } 
        }

        function getOffset(el) {
            const rect = el.getBoundingClientRect();
            return {
                left: rect.left + window.scrollX,
                top: rect.top + window.scrollY
            };
        }

        function showLecSpawn(choice){
            document.getElementById("lecSpawnLi").style.color = "white";
            document.getElementById("lecBattleLi").style.color = "white";
            menu = document.getElementById("lecSpawn");
            menu.style.width = "100%";	
            menu.style.height = "100%";
            menu.style.visibility = "visible";
            li = document.getElementById(choice);
            li.style.color = "red";
            document.getElementById("gameOpBox").value = choice;
        }

        function showCam(spriteImg, id){
            camDiv = document.getElementById("reader");
            camDiv.style.width = "500px";
            camDiv.style.height = "375px";
            camDiv.style.visibility = "visible";
            canBut = document.getElementById('cam-button-cancel');
            canBut.style.width = "100px";
            canBut.style.height = "30px";
            canBut.style.visibility = "visible";

            document.getElementById('current-lec').value = spriteImg;
            //console.log("url : " + document.getElementById('current-lec').value);

            document.getElementById('current-lec-id').value = id;
            //console.log("id : " + document.getElementById('current-lec-id').value);
        }

        function hideCam(){
            camDiv = document.getElementById("reader");
            camDiv.style.width = "0";
            camDiv.style.height = "0";
            camDiv.style.visibility = "hidden";
            canBut = document.getElementById('cam-button-cancel');
            canBut.style.width = "0";
            canBut.style.height = "0";
            canBut.style.visibility = "hidden";
        }

    </script>
    <script type="text/javascript" src='{% static "/eugo/js/html5-qrcode.min.js" %}'>
    </script>
    <script type="text/javascript">

        function onScanSuccess(decodedText, decodedResult) {
            curLec = document.getElementById('current-lec').value
            console.log(curLec + " ?= " + decodedText);
            if(curLec == decodedText + ".png"){
                alert("matched QR!")
                
                //create form of lecturer and submit to /eugo/catch
                let windowName = 'w_' + Date.now() + Math.floor(Math.random() * 100000).toString();
                var form = document.createElement("form");
                form.setAttribute("method", "post");
                form.setAttribute("action", "/eugo/catch/");
                form.setAttribute("target", windowName);

                var hiddenField = document.createElement("input"); 
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", "lecID");
                hiddenField.setAttribute("value", decodedText);
                form.appendChild(hiddenField);
                document.body.appendChild(form);

                window.open('', windowName);

                form.submit();
            }
            else{
                alert("invalid QR!")
            }
        }

        function onScanFailure(error) {
            // handle scan failure, usually better to ignore and keep scanning.
            // for example:
            console.warn(`Code scan error = ${error}`);
        }

        let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250} },
        /* verbose= */ false);
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>

